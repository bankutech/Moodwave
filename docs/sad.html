<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>DJ MoodWave Sad</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
* { margin:0; padding:0; box-sizing:border-box; font-family:"Segoe UI",sans-serif; }

body {
  height:100vh;
  overflow:hidden;
  display:flex;
  justify-content:center;
  align-items:center;
  color:#fff;

  /* Original blue background kept, middle area overlayed with soft purple-gray for sad mood */
  background:
    radial-gradient(circle at center, rgba(139,92,246,0.35) 0%, rgba(79,70,229,0) 40%), /* soft purple overlay */
    radial-gradient(circle at top, #0ea5e9 0%, transparent 35%), /* original blue top */
    radial-gradient(circle at bottom, #020617, #000814); /* original blue bottom */
}

/* Floating blue glow circles */
body::before, body::after {
  content:"";
  position:absolute;
  width:700px;
  height:700px;
  border-radius:50%;
  background: radial-gradient(circle, rgba(14,165,233,0.35), transparent 60%);
  filter: blur(120px);
  animation: move 10s infinite alternate;
}
body::after { animation-delay: 3s; }

@keyframes move {
  from { transform: translate(-150px,-150px);}
  to { transform: translate(150px,150px);}
}

/* Player container */
.player {
  width:100%;
  height:100%;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  z-index:2;
}

/* Title */
h1 {
  font-size:2.5rem;
  letter-spacing:4px;
  margin-bottom:35px;
  text-shadow: 0 0 20px #8b5cf6, 0 0 40px #4f46e5; /* soft purple glow */
  color:#fff;
}

/* Visualizer bars */
.visualizer {
  display:flex;
  align-items:flex-end;
  gap:10px;
  height:240px;
}

.bar {
  width:12px;
  height:30px;
  border-radius:20px;
  background: linear-gradient(180deg, #8b5cf6, #7c3aed, #4f46e5); /* soft purple gradient */
  box-shadow: 0 0 15px #8b5cf6, 0 0 35px #4f46e5;
  transition: height 0.07s ease;
}

/* Play Button */
button {
  margin-top:45px;
  padding:16px 50px;
  font-size:18px;
  letter-spacing:2px;
  border:none;
  border-radius:50px;
  background: linear-gradient(90deg, #8b5cf6, #7c3aed);
  color:#fff;
  cursor:pointer;
  box-shadow:0 0 25px #8b5cf6,0 0 50px #7c3aed;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

button:hover { transform: scale(1.1); }

.controls { display:flex; align-items:center; gap:20px; margin-top:30px; }
.control-btn { padding:12px 20px; font-size:16px; margin-top:0; }
.shuffle-btn { padding:12px 20px; font-size:16px; margin-top:0; }
.shuffle-btn.active { background: linear-gradient(90deg, #7c3aed, #8b5cf6); box-shadow:0 0 30px #8b5cf6,0 0 60px #7c3aed; }

/* Back Button */
.back-btn {
  position: fixed;
  top:25px;
  left:25px;
  padding:10px 22px;
  font-size:16px;
  border:none;
  border-radius:30px;
  background: linear-gradient(90deg, #8b5cf6, #7c3aed);
  color:#fff;
  cursor:pointer;
  box-shadow:0 0 15px #8b5cf6,0 0 35px #7c3aed;
  z-index:999;
}

.back-btn:hover {
  transform: scale(1.1);
  box-shadow:0 0 25px #8b5cf6,0 0 60px #7c3aed;
}

audio{display:none;}
</style>
</head>

<body>

<!-- Back button -->
<button class="back-btn" onclick="window.location.href='mood.html'">‚üµ Back</button>

<div class="player">
<h1> Sad MoodWave</h1>
<div class="visualizer" id="visualizer"></div>
<div class="controls">
  <button class="control-btn" id="prevBtn">‚èÆ PREV</button>
  <button id="playBtn">‚ñ∂ PLAY</button>
  <button class="control-btn" id="nextBtn">NEXT ‚è≠</button>
</div>
<button class="shuffle-btn" id="shuffleBtn">üîÄ SHUFFLE</button>
<audio id="audio" controls></audio>
</div>

<script>
const audio=document.getElementById("audio");
const playBtn=document.getElementById("playBtn");
const visualizer=document.getElementById("visualizer");
const barsCount=52;
const bars=[];

// Create bars
for(let i=0;i<barsCount;i++){
  const bar=document.createElement("div");
  bar.className="bar";
  visualizer.appendChild(bar);
  bars.push(bar);
}

let audioContext,analyser,dataArray;
let currentSongIndex=0;
let songs=[];
let isShuffle=false;
let shuffleOrder=[];

// Fetch Sad songs from backend. If backend is not reachable (e.g., served from GitHub Pages),
// rewrite local URLs to raw GitHub URLs so audio can still be loaded from the repository.
const _GITHUB_RAW_BASE = 'https://raw.githubusercontent.com/bankutech/Moodwave/main/';
function toRawGithubUrl(possibleUrl){
  if(!possibleUrl) return possibleUrl;
  try{
    // Remove any leading host (like http://localhost:3000/) or leading slashes
    let rel = possibleUrl.replace(/^https?:\/\/[^^\/]+\//i, '');
    rel = rel.replace(/^\/+/, '');
    return _GITHUB_RAW_BASE + encodeURI(rel);
  }catch(e){ return possibleUrl; }
}

.fetch('/songs?mood=Sad')
.then(res=>res.json())
.then(data=>{
  songs = data.map(song => {
    if(song && song.audio_url){
      // If the audio_url points to localhost (backend) and we're not on localhost, use raw GitHub
      if((song.audio_url.startsWith('http://localhost') || song.audio_url.startsWith('https://localhost')) && location.hostname !== 'localhost'){
        song.audio_url = toRawGithubUrl(song.audio_url);
      }
      // If it's a relative path (starts with something like "public/" or "backend/"), convert it too
      if(!song.audio_url.startsWith('http') && location.hostname !== 'localhost'){
        song.audio_url = _GITHUB_RAW_BASE + encodeURI(song.audio_url.replace(/^\/+/, ''));
      }
    }
    return song;
  });

  if(songs.length>0) {
    initializeShuffle();
    loadSong(0);
    playBtn.textContent='‚ñ∂ PLAY';
  }
})
.catch(err=>{
  console.error("Error fetching songs:", err);
  // fallback to a small local sample if fetching fails
  songs = [{ title: 'Sample', audio_url: 'music/sample.mp3' }];
  initializeShuffle();
  loadSong(0);
});

function initializeShuffle(){shuffleOrder=Array.from({length:songs.length},(_,i)=>i);}
function shuffleArray(array){const shuffled=[...array];for(let i=shuffled.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[shuffled[i],shuffled[j]]=[shuffled[j],shuffled[i]];}return shuffled;}
function loadSong(index){if(index<0||index>=songs.length)return;currentSongIndex=index;audio.src=songs[currentSongIndex].audio_url;audio.load();const wasPlaying=!audio.paused;if(wasPlaying){audio.play().catch(err=>console.error('Error playing song:',err));}}
function getNextIndex(){if(isShuffle){const currentPos=shuffleOrder.indexOf(currentSongIndex);const nextPos=(currentPos+1)%shuffleOrder.length;return shuffleOrder[nextPos];}else{return(currentSongIndex+1)%songs.length;}}
function getPrevIndex(){if(isShuffle){const currentPos=shuffleOrder.indexOf(currentSongIndex);const prevPos=(currentPos-1+shuffleOrder.length)%shuffleOrder.length;return shuffleOrder[prevPos];}else{return(currentSongIndex-1+songs.length)%songs.length;}}

audio.addEventListener('error', (e)=>{
  console.error('Audio error:', e);
  playBtn.textContent='‚ùå Error loading audio';
});

audio.addEventListener('canplay', ()=>{
  console.log('Audio ready to play');
});

// Play button
playBtn.addEventListener("click",()=>{
  if(songs.length===0){
    alert('No songs available. Please wait for songs to load.');
    return;
  }
  
  if(!audioContext){
    audioContext=new AudioContext();
    const source=audioContext.createMediaElementSource(audio);
    analyser=audioContext.createAnalyser();
    analyser.fftSize=128;
    dataArray=new Uint8Array(analyser.frequencyBinCount);
    source.connect(analyser);
    analyser.connect(audioContext.destination);
  }
  
  if(audio.paused){
    audio.play().then(()=>{
      playBtn.textContent='‚è∏ PAUSE';
      animate();
    }).catch(err=>{
      console.error('Play error:', err);
      alert('Error playing audio. Please check the console for details.');
    });
  }else{
    audio.pause();
    playBtn.textContent='‚ñ∂ PLAY';
  }
});

// Animate bars
function animate(){
  requestAnimationFrame(animate);
  if(!analyser) return;
  analyser.getByteFrequencyData(dataArray);
  bars.forEach((bar,i)=>{
    const value=dataArray[i]||0;
    bar.style.height=Math.max(25,value*1.2)+"px";
  });
}

document.getElementById("nextBtn").addEventListener("click",()=>{if(songs.length===0)return;const nextIndex=getNextIndex();loadSong(nextIndex);if(!audio.paused){audio.play().catch(err=>console.error('Error playing next song:',err));}});
document.getElementById("prevBtn").addEventListener("click",()=>{if(songs.length===0)return;const prevIndex=getPrevIndex();loadSong(prevIndex);if(!audio.paused){audio.play().catch(err=>console.error('Error playing previous song:',err));}});
document.getElementById("shuffleBtn").addEventListener("click",()=>{isShuffle=!isShuffle;const shuffleBtn=document.getElementById("shuffleBtn");if(isShuffle){shuffleOrder=shuffleArray(Array.from({length:songs.length},(_,i)=>i));const currentPos=shuffleOrder.indexOf(currentSongIndex);if(currentPos>0){[shuffleOrder[0],shuffleOrder[currentPos]]=[shuffleOrder[currentPos],shuffleOrder[0]];}shuffleBtn.classList.add("active");shuffleBtn.textContent="üîÄ SHUFFLE ON";}else{shuffleBtn.classList.remove("active");shuffleBtn.textContent="üîÄ SHUFFLE";}});
audio.addEventListener("ended",()=>{if(songs.length===0)return;const nextIndex=getNextIndex();loadSong(nextIndex);audio.play().catch(err=>console.error('Error playing next song:',err));});
</script>

</body>
</html>
