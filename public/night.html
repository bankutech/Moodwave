<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>DJ MoodWave Night</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
* { margin:0; padding:0; box-sizing:border-box; font-family:"Segoe UI",sans-serif; }

body {
  height:100vh;
  overflow:hidden;
  display:flex;
  justify-content:center;
  align-items:center;
  color:#fff;

  /* Original blue background kept, middle overlay for night mood */
  background:
    radial-gradient(circle at center, rgba(79,70,229,0.25) 0%, rgba(55,48,163,0) 40%), /* soft purple overlay */
    radial-gradient(circle at top, #0ea5e9 0%, transparent 35%), /* blue top */
    radial-gradient(circle at bottom, #020617, #000814); /* blue bottom */
}

/* Floating blue glow circles */
body::before, body::after {
  content:"";
  position:absolute;
  width:700px;
  height:700px;
  border-radius:50%;
  background: radial-gradient(circle, rgba(14,165,233,0.35), transparent 60%);
  filter: blur(120px);
  animation: move 10s infinite alternate;
}
body::after { animation-delay: 3s; }

@keyframes move {
  from { transform: translate(-150px,-150px);}
  to { transform: translate(150px,150px);}
}

/* Player container */
.player {
  width:100%;
  height:100%;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  z-index:2;
}

/* Title */
h1 {
  font-size:2.5rem;
  letter-spacing:4px;
  margin-bottom:35px;
  text-shadow: 0 0 20px #4f46e5, 0 0 40px #3730a3; /* soft purple glow */
  color:#fff;
}

/* Visualizer bars */
.visualizer {
  display:flex;
  align-items:flex-end;
  gap:10px;
  height:240px;
}

.bar {
  width:12px;
  height:30px;
  border-radius:20px;
  background: linear-gradient(180deg, #7c3aed, #4f46e5, #3730a3); /* purple → deep blue */
  box-shadow: 0 0 15px #7c3aed, 0 0 35px #4f46e5;
  transition: height 0.07s ease;
}

/* Play Button */
button {
  margin-top:45px;
  padding:16px 50px;
  font-size:18px;
  letter-spacing:2px;
  border:none;
  border-radius:50px;
  background: linear-gradient(90deg, #7c3aed, #4f46e5);
  color:#fff;
  cursor:pointer;
  box-shadow:0 0 25px #7c3aed,0 0 50px #4f46e5;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

button:hover { transform: scale(1.1); }

/* Back Button */
.back-btn {
  position: fixed;
  top:25px;
  left:25px;
  padding:10px 22px;
  font-size:16px;
  border:none;
  border-radius:30px;
  background: linear-gradient(90deg, #7c3aed, #4f46e5);
  color:#fff;
  cursor:pointer;
  box-shadow:0 0 15px #7c3aed,0 0 35px #4f46e5;
  z-index:999;
}

.back-btn:hover {
  transform: scale(1.1);
  box-shadow:0 0 25px #7c3aed,0 0 60px #4f46e5;
}

audio{display:none;}
</style>
</head>

<body>

<!-- Back button -->
<button class="back-btn" onclick="window.location.href='mood.html'">⟵ Back</button>

<div class="player">
<h1>Night MoodVibes</h1>
<div class="visualizer" id="visualizer"></div>
<button id="playBtn">▶ PLAY</button>
<audio id="audio" controls></audio>
</div>

<script>
const audio=document.getElementById("audio");
const playBtn=document.getElementById("playBtn");
const visualizer=document.getElementById("visualizer");
const barsCount=52;
const bars=[];

// Create bars
for(let i=0;i<barsCount;i++){
  const bar=document.createElement("div");
  bar.className="bar";
  visualizer.appendChild(bar);
  bars.push(bar);
}

let audioContext,analyser,dataArray;
let currentSongIndex=0;
let songs=[];

// Fetch Night songs from backend
fetch('http://localhost:3000/songs?mood=Night')
.then(res=>res.json())
.then(data=>{
  songs=data;
  if(songs.length>0) {
    audio.src=songs[0].audio_url;
    audio.load();
    playBtn.textContent='▶ PLAY';
  }
})
.catch(err=>console.error("Error fetching songs:", err));

audio.addEventListener('error', (e)=>{
  console.error('Audio error:', e);
  playBtn.textContent='❌ Error loading audio';
});

audio.addEventListener('canplay', ()=>{
  console.log('Audio ready to play');
});

// Play button
playBtn.addEventListener("click",()=>{
  if(songs.length===0){
    alert('No songs available. Please wait for songs to load.');
    return;
  }
  
  if(!audioContext){
    audioContext=new AudioContext();
    const source=audioContext.createMediaElementSource(audio);
    analyser=audioContext.createAnalyser();
    analyser.fftSize=128;
    dataArray=new Uint8Array(analyser.frequencyBinCount);
    source.connect(analyser);
    analyser.connect(audioContext.destination);
  }
  
  if(audio.paused){
    audio.play().then(()=>{
      playBtn.textContent='⏸ PAUSE';
      animate();
    }).catch(err=>{
      console.error('Play error:', err);
      alert('Error playing audio. Please check the console for details.');
    });
  }else{
    audio.pause();
    playBtn.textContent='▶ PLAY';
  }
});

// Animate bars
function animate(){
  requestAnimationFrame(animate);
  if(!analyser) return;
  analyser.getByteFrequencyData(dataArray);
  bars.forEach((bar,i)=>{
    const value=dataArray[i]||0;
    bar.style.height=Math.max(25,value*1.3)+"px"; // calm height
  });
}

// Auto next song when current ends
audio.addEventListener("ended", ()=>{
  if(songs.length === 0) return;
  currentSongIndex = (currentSongIndex + 1) % songs.length;
  audio.src = songs[currentSongIndex].audio_url;
  audio.load();
  audio.play().catch(err=>console.error('Error playing next song:', err));
});
</script>

</body>
</html>
